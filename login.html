<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自定义文件上传</title>
    <style>
        .upload-box { padding: 30px; max-width: 500px; margin: 50px auto; border: 1px dashed #ccc; border-radius: 8px; text-align: center; }
        #fileInput { margin: 20px 0; padding: 10px; }
        #uploadBtn { padding: 10px 30px; background: #2ea44f; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        #tip { margin-top: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>文件上传至仓库</h2>
        <input type="file" id="fileInput" multiple>
        <button id="uploadBtn">开始上传</button>
        <div id="tip"></div>
    </div>

    <script>
        const config = {
            owner: "fox925",
            repo: "fox",
            branch: "main",
            token: "你的GitHub个人访问令牌", // 替换为你的令牌
            folder: ""
        };

        document.getElementById("uploadBtn").addEventListener("click", async () => {
            const fileInput = document.getElementById("fileInput");
            const tip = document.getElementById("tip");
            if (!fileInput.files.length) {
                tip.style.color = "#dc3545";
                tip.textContent = "请选择要上传的文件！";
                return;
            }

            tip.textContent = "上传中...";
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const base64Str = e.target.result.split(",")[1];
                const fileName = file.name;
                const fileUrl = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.folder}${fileName}`;
                // 关键修复：Authorization 头添加 Bearer 前缀
                const authHeader = `Bearer ${config.token}`;

                try {
                    const res = await fetch(fileUrl, {
                        headers: { "Authorization": authHeader }
                    });
                    
                    const data = await res.json();
                    const requestData = {
                        message: `上传文件：${fileName}`,
                        content: base64Str,
                        branch: config.branch
                    };
                    if (data.sha) requestData.sha = data.sha;

                    const uploadRes = await fetch(fileUrl, {
                        method: res.ok ? "PUT" : "POST",
                        headers: {
                            "Authorization": authHeader,
                            "Content-Type": "application/json;charset=UTF-8"
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (uploadRes.ok) {
                        tip.style.color = "#28a745";
                        tip.textContent = `文件${fileName}上传成功！`;
                    } else {
                        tip.style.color = "#dc3545";
                        tip.textContent = "上传失败，检查令牌和仓库配置！";
                    }
                } catch (err) {
                    tip.style.color = "#dc3545";
                    tip.textContent = "上传出错：" + err.message;
                }
            };

            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>
